/*! angular-sails-bind - v0.0.13 - 2014-05-29
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2014 Diego Pamio; Licensed MIT */
var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$socket",function(a){"use strict";var b=function(b,c,d){!function(){a.get("/"+b,d).then(function(a){c[b+"s"]=a}),a.on(b,function(a){var d=c[b+"s"],e={created:function(){c[b+"s"].push(a.data)},updated:function(){var d=c[b+"s"].find(function(b){return parseInt(a.id,10)===parseInt(b.id,10)});angular.extend(d,a.data)},destroyed:function(){var e=c[b+"s"].find(function(b){return b.id===a.id});d.splice(d.indexOf(e),1)}};e[a.verb]()}),c.$watchCollection(b+"s",function(d,e){function f(d){d.forEach(function(d){c.$watchCollection(b+"s["+c[b+"s"].indexOf(d)+"]",function(c,d){d&&c&&(angular.equals(d,c)||parseInt(d.id,10)!==parseInt(c.id,10)||d.updatedAt!==c.updatedAt||a.post("/"+b+"/update/"+d.id,angular.copy(c)))})})}!e&&d&&f(d);var g,h;d=d||[],e=e||[],g=d.diff(e),h=e.diff(d),h.forEach(function(c){a.remove("/"+b+"/destroy/"+c.id)}),g.forEach(function(c){c.id||a.put("/"+b+"/create/",c,function(d){a.get("/"+b+"/"+d.id).then(function(a){angular.extend(c,a)})}),f(g)})})}()};return{bind:b}}]),app.factory("$socket",["$q","$rootScope",function(a,b){"use strict";var c={},d=function(b,d){var e=new a.defer;return d=d||{},d.cache=d.cache||!1,c[b]&&d.cache?e.resolve(c[b]):(delete d.cache,io.socket.request(b,d,function(a){c[b]=a,e.resolve(a)})),e.promise},e=function(a,c){io.socket.on(a,function(){var a=arguments;b.$apply(function(){c.apply(io.socket,a)})})},f=function(a,b,c){io.socket.post(a,b,c)},g=function(a,b,c){io.socket.put(a,b,c)},h=function(a,b){io.socket.delete(a,b)},i=function(a,b,c){if(b.model===a){var d,e,f;if("create"===b.verb&&c.push(b.data),"update"===b.verb)for(f=Object.keys(b.data),d=0;d<c.length;d+=1)if(c[d].id===b.id)for(e=0;e<f.length;e+=1)c[d][f[e]]=b.data[f[e]];if("destroy"===b.verb)for(d=0;d<c.length;d+=1)c[d].id===b.id&&c.splice(d,1)}};return{get:d,on:e,post:f,put:g,remove:h,handleMessage:i}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}}),Array.prototype.diff||(Array.prototype.diff=function(a){return this.filter(function(b){return a.indexOf(b)<0})});